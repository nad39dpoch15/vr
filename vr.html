<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR –ú–∏–Ω–∏-–∏–≥—Ä–∞: –°–±–æ—Ä –æ–±—ä–µ–∫—Ç–æ–≤</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@^4.2.1/dist/aframe-event-set-component.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@v5.0.0/dist/aframe-physics-system.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-particle-system-component@1.2.3/dist/aframe-particle-system-component.min.js"></script>
</head>
<body>
<a-scene physics="debug: false; gravity: -9.8;" vr-mode-ui="enabled: true">

    <a-light type="ambient" color="#88CCFF" intensity="0.4"></a-light>
    <a-light type="directional" color="#FFFFFF" intensity="0.8" position="10 20 -10"></a-light>
    <a-light type="point" color="#FFDD99" intensity="0.6" position="0 10 0" distance="25"></a-light>
    <a-light type="point" color="#99DDFF" intensity="0.5" position="-15 5 -15" distance="20"></a-light>
    <a-light type="point" color="#FF99CC" intensity="0.4" position="15 5 15" distance="20"></a-light>

    <a-entity sound="src: url(https://cdn.aframe.io/audio/boop.ogg); autoplay: false" id="collectSound"></a-entity>
    <a-entity sound="src: url(https://cdn.aframe.io/audio/ping.ogg); autoplay: false" id="timeWarningSound"></a-entity>
    <a-entity sound="src: url(https://cdn.aframe.io/audio/bang.ogg); autoplay: false" id="timeEndSound"></a-entity>
    <a-entity sound="src: url(https://cdn.aframe.io/audio/win.ogg); autoplay: false" id="winSound"></a-entity>
    <a-entity sound="src: url(https://cdn.aframe.io/audio/lose.ogg); autoplay: false" id="loseSound"></a-entity>

    <a-entity id="timerPanel" position="-1 0.35 -1">
        <a-plane position="0 0 0" width="0.5" height="0.3" color="#222" opacity="0.8"></a-plane>
        <a-text id="timerDisplay" value="01:00" position="0 0 0.01" scale="1.2 1.2 1.2" color="#00FF00" align="center"></a-text>
        <a-text value="–¢–ê–ô–ú–ï–†" position="0 0.18 0.01" scale="0.5 0.5 0.5" color="#EF2D5E" align="center"></a-text>
    </a-entity>

    <a-entity id="scorePanel" position="1 0.35 -1">
        <a-plane position="0 0 0" width="0.5" height="0.3" color="#222" opacity="0.8"></a-plane>
        <a-text id="scoreDisplay" value="0" position="0 0 0.01" scale="1.2 1.2 1.2" color="#FFC65D" align="center"></a-text>
        <a-text value="–û–ß–ö–ò" position="0 0.18 0.01" scale="0.5 0.5 0.5" color="#4CC3D9" align="center"></a-text>
    </a-entity>

    <a-entity id="progressPanel" position="0 0.35 -1">
        <a-plane position="0 0 0" width="0.5" height="0.3" color="#222" opacity="0.8"></a-plane>
        <a-text id="collectedCounter" value="0/14" position="0 0 0.01" scale="1 1 1" color="#7FFF00" align="center"></a-text>
        <a-text value="–°–û–ë–†–ê–ù–û" position="0 0.18 0.01" scale="0.5 0.5 0.5" color="#8A2BE2" align="center"></a-text>
    </a-entity>

    <a-sky color="#8DD" src="https://cdn.aframe.io/360-image-gallery-boilerplate/img/sechelt.jpg"></a-sky>
    <a-plane id="ground" position="0 0 0" rotation="-90 0 0" width="50" height="50" color="#7BC8A4" src="https://cdn.aframe.io/360-image-gallery-boilerplate/img/floor.jpg" repeat="10 10" static-body></a-plane>

    <a-entity id="player" position="0 0 5">
        <a-camera id="camera" look-controls wasd-controls="acceleration: 65; fly: true;" position="0 1.6 0">
            <a-cursor raycaster="objects: .collectible; far: 20; interval: 100;" 
                     fuse="false" 
                     scale="0.1 0.1 0.1"
                     color="#FFFFFF"
                     opacity="0.8">
            </a-cursor>
        </a-camera>
        <a-sphere class="player-collider" radius="0.5" visible="false" position="0 0.5 0" static-body></a-sphere>
    </a-entity>

    <a-entity id="gameOverPanel" position="0 2 -3" visible="false">
        <a-plane width="4" height="2.5" color="#111" opacity="0.9" shader="flat"></a-plane>
        <a-plane position="0 0 0.01" width="3.9" height="2.4" color="#222" opacity="0.8" shader="flat"></a-plane>
        
        <a-text id="gameOverTitle" value="–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê" position="0 0.8 0.02" scale="1.2 1.2 1.2" color="#FF5555" align="center" width="3"></a-text>
        
        <a-text id="gameOverReason" value="–í—Ä–µ–º—è –≤—ã—à–ª–æ!" position="0 0.3 0.02" scale="0.9 0.9 0.9" color="#FFAA00" align="center" width="3"></a-text>
        <a-text id="gameOverScore" value="–°—á–µ—Ç: 0" position="0 0 0.02" scale="1 1 1" color="#FFFFFF" align="center" width="3"></a-text>
        <a-text id="gameOverCollected" value="–°–æ–±—Ä–∞–Ω–æ: 0/14" position="0 -0.3 0.02" scale="0.9 0.9 0.9" color="#88FF88" align="center" width="3"></a-text>
   
        <a-text value="–ù–∞–∂–º–∏—Ç–µ R –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞" position="0 -0.9 0.02" scale="0.6 0.6 0.6" color="#AAAAAA" align="center" width="3"></a-text>
        
        <a-animation attribute="scale" from="0 0 0" to="1 1 1" dur="500" easing="easeOutElastic"></a-animation>
    </a-entity>

    <a-cone id="movingObj" class="collectible" data-value="30" position="0 3 -8" 
            radius-bottom="0.5" height="1" color="red"
            dynamic-body
            animation="property: position; to: 5 3 -8; dur: 2000; loop: true; dir: alternate">
    </a-cone>
    <a-cone id="movingObj2" class="collectible" data-value="30" position="-3 3 -10" 
            radius-bottom="0.5" height="1" color="orange"
            dynamic-body
            animation="property: position; to: -8 3 -10; dur: 3000; loop: true; dir: alternate">
    </a-cone>

    <a-sphere class="collectible" data-value="10" position="-5 5 -5" radius="0.5" color="#EF2D5E" dynamic-body></a-sphere>
    <a-sphere class="collectible" data-value="10" position="5 5 0" radius="0.5" color="#4CC3D9" dynamic-body></a-sphere>
    <a-box class="collectible" data-value="15" position="0 5 -8" width="1" height="1" depth="1" color="#FFC65D" dynamic-body></a-box>
    <a-box class="collectible" data-value="15" position="-3 5 3" width="1" height="1" depth="1" color="#7FFF00" dynamic-body></a-box>
    <a-cylinder class="collectible" data-value="20" position="4 5 -10" radius="0.5" height="1.5" color="#FF1493" dynamic-body></a-cylinder>
    <a-torus class="collectible" data-value="25" position="6 5 5" radius="0.7" radius-tubular="0.1" color="#00FFFF" dynamic-body></a-torus>
    <a-sphere class="collectible" data-value="10" position="-8 5 2" radius="0.4" color="#FF4500" dynamic-body></a-sphere>
    <a-box class="collectible" data-value="15" position="2 5 10" width="0.8" height="0.8" depth="0.8" color="#32CD32" dynamic-body></a-box>
    <a-cylinder class="collectible" data-value="20" position="8 5 -3" radius="0.6" height="1.2" color="#FFD700" dynamic-body></a-cylinder>

    <a-entity class="collectible" data-value="100" id="heartObject" position="0 5 -15" scale="0.5 0.5 0.5" dynamic-body
              animation="property: rotation; to: 0 360 0; dur: 8000; loop: true">
        <a-cone position="-0.3 0 0" radius-bottom="0.8" radius-top="0" height="1.6" color="#FF1493" rotation="0 0 -45"></a-cone>
        <a-cone position="0.3 0 0" radius-bottom="0.8" radius-top="0" height="1.6" color="#FF1493" rotation="0 0 45"></a-cone>
        <a-cone position="0 -0.8 0" radius-bottom="0.8" radius-top="0" height="1" color="#FF1493" rotation="180 0 0"></a-cone>
        <a-sphere position="0 0.5 0.3" radius="0.2" color="#FFB6C1" opacity="0.6"></a-sphere>
        <a-ring position="0 0 0" radius-inner="0.7" radius-outer="0.9" color="#FF1493" opacity="0.3"></a-ring>
    </a-entity>

    <a-entity class="collectible" data-value="75" id="starObject" position="10 5 10" scale="0.4 0.4 0.4" dynamic-body
              animation="property: rotation; to: 360 360 360; dur: 6000; loop: true">
        <a-cylinder position="0 0 0" radius="0.3" height="0.3" color="#FFDF00"></a-cylinder>
        <a-cone position="0 0.8 0" radius-bottom="0.2" radius-top="0" height="1" color="#FFDF00"></a-cone>
        <a-cone position="0.6 0.4 0" radius-bottom="0.2" radius-top="0" height="0.8" color="#FFDF00" rotation="0 0 -60"></a-cone>
        <a-cone position="0.6 -0.7 0" radius-bottom="0.2" radius-top="0" height="0.8" color="#FFDF00" rotation="10 -5 220"></a-cone>
        <a-cone position="-0.6 0.4 0" radius-bottom="0.2" radius-top="0" height="0.8" color="#FFDF00" rotation="0 0 60"></a-cone>
        <a-cone position="-0.6 -0.4 0" radius-bottom="0.2" radius-top="0" height="0.8" color="#FFDF00" rotation="0 0 470"></a-cone>
        <a-cone position="0 -0.8 0" radius-bottom="0.2" radius-top="0" height="1" color="#FFDF00" rotation="180 0 0"></a-cone>
    </a-entity>

</a-scene>

<script>
    
    let score = 0;
    let timeLeft = 60;
    let gameActive = true;
    let timerInterval;
    let collectedCount = 0;
    const totalObjects = 14;
    let gameOver = false;

    function playCollectSound() {
        const sound = document.querySelector('#collectSound');
        if (sound && sound.components.sound) {
            sound.components.sound.playSound();
        }
    }

    function createParticleExplosion(position, color = '#FFAA00') {
        for (let i = 0; i < 3; i++) {
            setTimeout(() => {
                const explosion = document.createElement('a-entity');
                explosion.setAttribute('position', position);
                explosion.setAttribute('particle-system', {
                    preset: 'explosion',
                    color: color + ', white, yellow',
                    particleCount: 15,
                    maxAge: 0.6,
                    velocityValue: `${(Math.random() - 0.5) * 3} ${Math.random() * 3} ${(Math.random() - 0.5) * 3}`,
                    accelerationValue: '0 -2 0',
                    positionSpread: '0.8 0.8 0.8',
                    size: 0.15,
                    opacity: 0.9
                });
                document.querySelector('a-scene').appendChild(explosion);
                setTimeout(() => explosion.remove(), 600);
            }, i * 50);
        }
    }

    function updateScoreDisplay() {
        document.getElementById('scoreDisplay').setAttribute('value', score.toString());
        document.getElementById('collectedCounter').setAttribute('value', `${collectedCount}/${totalObjects}`);
    }

    function collectObject(object) {
        if (!gameActive || gameOver) return;
        if (!object || !object.parentNode) return;

        const objectValue = parseInt(object.getAttribute('data-value')) || 10;
        score += objectValue;
        collectedCount++;
        
        console.log(`–°–æ–±—Ä–∞–Ω–æ! +${objectValue} –æ—á–∫–æ–≤. –í—Å–µ–≥–æ: ${score}`);
        updateScoreDisplay();
        playCollectSound();
        
        const objectPosition = object.getAttribute('position');
        
        let particleColor = '#FFAA00';
        if (object.id === 'heartObject') particleColor = '#FF1493';
        else if (object.id === 'starObject') particleColor = '#FFD700';
        else if (object.id && object.id.includes('movingObj')) particleColor = '#FF5500';
        
        createParticleExplosion(objectPosition, particleColor);

        object.setAttribute('animation', {
            property: 'scale',
            to: '0 0 0',
            dur: 300,
            easing: 'easeInBack'
        });

        setTimeout(() => {
            if (object && object.parentNode) {
                object.parentNode.removeChild(object);
                checkWinCondition();
            }
        }, 300);
    }

    function checkWinCondition() {
        const remainingObjects = document.querySelectorAll('.collectible').length;
        if (remainingObjects === 0 && gameActive && !gameOver) {
            endGame(true, "–ü–û–ë–ï–î–ê! üèÜ");
        }
    }

    function showGameOverPanel(isWin, reason) {
        const panel = document.getElementById('gameOverPanel');
        if (!panel) return;
        
        const titleEl = document.getElementById('gameOverTitle');
        const reasonEl = document.getElementById('gameOverReason');
        const scoreEl = document.getElementById('gameOverScore');
        const collectedEl = document.getElementById('gameOverCollected');
        
        if (titleEl) titleEl.setAttribute('value', isWin ? 'üéâ –ü–û–ë–ï–î–ê! üéâ' : '‚è∞ –ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê');
        if (titleEl) titleEl.setAttribute('color', isWin ? '#FFD700' : '#FF5555');
        
        if (reasonEl) reasonEl.setAttribute('value', reason);
        if (scoreEl) scoreEl.setAttribute('value', `–°—á–µ—Ç: ${score}`);
        if (collectedEl) collectedEl.setAttribute('value', `–°–æ–±—Ä–∞–Ω–æ: ${collectedCount}/${totalObjects}`);
        
        panel.setAttribute('visible', 'true');
        
        const sound = document.querySelector(isWin ? '#winSound' : '#loseSound');
        if (sound && sound.components.sound) sound.components.sound.playSound();
        
        gameActive = false;
        gameOver = true;
        clearInterval(timerInterval);
        
        console.log(`–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: ${reason}. –°—á–µ—Ç: ${score}, –°–æ–±—Ä–∞–Ω–æ: ${collectedCount}/${totalObjects}`);
    }

    function endGame(isWin, reason) {
        if (gameOver) return;
        showGameOverPanel(isWin, reason);
    }

    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    function updateTimerDisplay() {
        const timerElement = document.getElementById('timerDisplay');
        timerElement.setAttribute('value', formatTime(timeLeft));
        
        if (timeLeft <= 10) {
            timerElement.setAttribute('color', '#FF0000');
            timerElement.setAttribute('animation', {
                property: 'scale',
                from: '1.2 1.2 1.2',
                to: '1.4 1.4 1.4',
                dur: 500,
                dir: 'alternate',
                loop: true
            });
        } else if (timeLeft <= 30) {
            timerElement.setAttribute('color', '#FFA500');
            timerElement.removeAttribute('animation');
        } else {
            timerElement.setAttribute('color', '#00FF00');
            timerElement.removeAttribute('animation');
        }
    }

    function startTimer() {
        timerInterval = setInterval(() => {
            if (gameActive && !gameOver && timeLeft > 0) {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft === 10) {
                    const warningSound = document.querySelector('#timeWarningSound');
                    if (warningSound && warningSound.components.sound) warningSound.components.sound.playSound();
                }
                
                if (timeLeft <= 0) {
                    endGame(false, "–í—Ä–µ–º—è –≤—ã—à–ª–æ! ‚è∞");
                }
            }
        }, 1000);
    }

    function setupCollectListeners() {
        const collectibles = document.querySelectorAll('.collectible');
        console.log(`–ù–∞–π–¥–µ–Ω–æ –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è —Å–±–æ—Ä–∞: ${collectibles.length}`);
        
        collectibles.forEach(obj => {
            obj.removeEventListener('click', obj.clickHandler);
            obj.removeEventListener('mouseenter', obj.mouseEnterHandler);
            obj.removeEventListener('mouseleave', obj.mouseLeaveHandler);
            
            obj.clickHandler = function(e) {
                e.stopPropagation();
                if (gameActive && !gameOver) {
                    console.log('–ö–ª–∏–∫ –ø–æ –æ–±—ä–µ–∫—Ç—É!', this.id || '–æ–±—ã—á–Ω—ã–π');
                    collectObject(this);
                }
            };
            
            obj.mouseEnterHandler = function() {
                if (gameActive && !gameOver) {
                    this.setAttribute('scale', '1.2 1.2 1.2');
                }
            };
            
            obj.mouseLeaveHandler = function() {
                this.setAttribute('scale', '1 1 1');
            };
            
            obj.addEventListener('click', obj.clickHandler);
            obj.addEventListener('mouseenter', obj.mouseEnterHandler);
            obj.addEventListener('mouseleave', obj.mouseLeaveHandler);
            
            obj.classList.add('clickable');
        });
    }

    function spawnObjects() {
        const positions = [];
        for (let i = 0; i < 5; i++) {
            const x = Math.random() * 10 - 5;
            const z = Math.random() * 10 - 5;
            positions.push({x, y: 3, z});
        }
        return positions;
    }

    function restartGame() {
        const panel = document.getElementById('gameOverPanel');
        if (panel) panel.setAttribute('visible', 'false');
        
        document.querySelectorAll('.collectible').forEach(el => {
            if (el.parentNode) el.parentNode.removeChild(el);
        });
        
        const positions = spawnObjects();
        positions.forEach(pos => {
            const sphere = document.createElement('a-sphere');
            sphere.setAttribute('class', 'collectible');
            sphere.setAttribute('data-value', '10');
            sphere.setAttribute('position', pos);
            sphere.setAttribute('radius', '0.5');
            sphere.setAttribute('color', '#EF2D5E');
            sphere.setAttribute('dynamic-body', '');
            document.querySelector('a-scene').appendChild(sphere);
        });
        const scene = document.querySelector('a-scene');
        
        const moving1 = document.createElement('a-cone');
        moving1.setAttribute('id', 'movingObj');
        moving1.setAttribute('class', 'collectible');
        moving1.setAttribute('data-value', '30');
        moving1.setAttribute('position', '0 3 -8');
        moving1.setAttribute('radius-bottom', '0.5');
        moving1.setAttribute('height', '1');
        moving1.setAttribute('color', 'red');
        moving1.setAttribute('dynamic-body', '');
        moving1.setAttribute('animation', 'property: position; to: 5 3 -8; dur: 2000; loop: true; dir: alternate');
        scene.appendChild(moving1);
        
        const moving2 = document.createElement('a-cone');
        moving2.setAttribute('id', 'movingObj2');
        moving2.setAttribute('class', 'collectible');
        moving2.setAttribute('data-value', '30');
        moving2.setAttribute('position', '-3 3 -10');
        moving2.setAttribute('radius-bottom', '0.5');
        moving2.setAttribute('height', '1');
        moving2.setAttribute('color', 'orange');
        moving2.setAttribute('dynamic-body', '');
        moving2.setAttribute('animation', 'property: position; to: -8 3 -10; dur: 3000; loop: true; dir: alternate');
        scene.appendChild(moving2);
   
        score = 0;
        timeLeft = 60;
        collectedCount = 0;
        gameActive = true;
        gameOver = false;
        
        updateScoreDisplay();
        updateTimerDisplay();

        setTimeout(() => {
            setupCollectListeners();
        }, 500);
        
        clearInterval(timerInterval);
        startTimer();
        
        console.log('–ò–≥—Ä–∞ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞!');
    }

    document.addEventListener('DOMContentLoaded', function() {
        console.log("===================================");
        console.log("VR –°–ë–û–† –û–ë–™–ï–ö–¢–û–í - –° –ü–õ–ê–®–ö–û–ô –ò–¢–û–ì–û–í");
        console.log("===================================");
        console.log("WASD - —Ö–æ–¥—å–±–∞");
        console.log("–ö–õ–ò–ö –ø–æ —Ñ–∏–≥—É—Ä–∞–º - —Å–±–æ—Ä");
        console.log("R - –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ (—Ä–∞–Ω–¥–æ–º–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏)");
        console.log("===================================");

        const panel = document.getElementById('gameOverPanel');
        if (panel) panel.setAttribute('visible', 'false');
        
        updateScoreDisplay();
        updateTimerDisplay();
        startTimer();
        
        setTimeout(() => {
            setupCollectListeners();
        }, 1000);
        
        document.addEventListener('keydown', function(e) {
            if (e.key === 'r' || e.key === 'R') {
                console.log('–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∏–≥—Ä—ã...');
                restartGame();
            }
        });
        
        const scene = document.querySelector('a-scene');
        scene.addEventListener('child-attached', function() {
            setTimeout(setupCollectListeners, 200);
        });
    });
    
    setTimeout(() => setupCollectListeners(), 3000);
    setTimeout(() => setupCollectListeners(), 5000);
</script>
</body>
</html>